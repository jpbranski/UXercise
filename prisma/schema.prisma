// Prisma schema for UXercise
// Database: PostgreSQL (Vercel Postgres / Prisma Postgres)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("PRISMA_DATABASE_URL")
}

// ============================================================================
// AUTH & USER MODELS (NextAuth.js compatible)
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  USER
  COACH
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // Coach relationships
  coachRelationships       CoachUserRelationship[] @relation("CoachRelation")
  coachClientRelationships CoachUserRelationship[] @relation("ClientRelation")

  // User-owned data
  programs         Program[]
  exercises        Exercise[] // Custom exercises created by this user
  bodyWeightEntries BodyWeightEntry[]
  workoutSessions  WorkoutSession[]

  // Programs created by this coach for others
  programsCreatedAsCoach Program[] @relation("CoachCreatedPrograms")

  // Change log entries
  changeLogEntriesAsActor  ChangeLogEntry[] @relation("ActorChangeLogs")
  changeLogEntriesAsTarget ChangeLogEntry[] @relation("TargetChangeLogs")

  @@index([email])
}

enum CoachRelationshipStatus {
  ACTIVE
  INACTIVE
}

model CoachUserRelationship {
  id        String                   @id @default(cuid())
  coachId   String
  coach     User                     @relation("CoachRelation", fields: [coachId], references: [id], onDelete: Cascade)
  userId    String
  user      User                     @relation("ClientRelation", fields: [userId], references: [id], onDelete: Cascade)
  status    CoachRelationshipStatus  @default(ACTIVE)
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt

  @@unique([coachId, userId])
  @@index([coachId])
  @@index([userId])
}

// ============================================================================
// EXERCISE LIBRARY
// ============================================================================

enum MuscleGroup {
  CHEST
  BACK
  LEGS
  SHOULDERS
  ARMS
  CORE
  FULL_BODY
  OTHER
}

model Exercise {
  id                    String       @id @default(cuid())
  name                  String
  description           String?      @db.Text
  primaryMuscleGroup    MuscleGroup
  secondaryMuscleGroups String[]     // Array of muscle group strings
  defaultEquipment      String       @default("bodyweight") // e.g., "barbell", "dumbbell", "machine"
  tags                  String[]     // Additional tags for filtering
  createdByUserId       String?      // null = global exercise
  createdBy             User?        @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  // Relations
  programExercises ProgramExercise[]
  workoutSets      WorkoutSet[]

  @@index([createdByUserId])
  @@index([primaryMuscleGroup])
}

// ============================================================================
// PROGRAM STRUCTURE
// ============================================================================

enum ScheduleType {
  WEEKLY    // Single week that repeats
  BIWEEKLY  // A/B week alternation
}

model Program {
  id               String       @id @default(cuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  description      String?      @db.Text
  scheduleType     ScheduleType @default(WEEKLY)
  isActive         Boolean      @default(false)
  createdByCoachId String?      // If created by a coach for a client
  createdByCoach   User?        @relation("CoachCreatedPrograms", fields: [createdByCoachId], references: [id])
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  weeks           ProgramWeek[]
  workoutSessions WorkoutSession[]

  @@index([userId])
  @@index([createdByCoachId])
  @@index([isActive])
}

enum WeekLabel {
  A
  B
}

model ProgramWeek {
  id        String     @id @default(cuid())
  programId String
  program   Program    @relation(fields: [programId], references: [id], onDelete: Cascade)
  label     WeekLabel? // A or B for biweekly, null for weekly
  order     Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  days ProgramDay[]

  @@index([programId])
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

model ProgramDay {
  id            String    @id @default(cuid())
  programWeekId String
  programWeek   ProgramWeek @relation(fields: [programWeekId], references: [id], onDelete: Cascade)
  dayOfWeek     DayOfWeek
  displayName   String    // e.g., "Push Day", "Leg Day"
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sections        ProgramSection[]
  workoutSessions WorkoutSession[]

  @@index([programWeekId])
}

model ProgramSection {
  id           String      @id @default(cuid())
  programDayId String
  programDay   ProgramDay  @relation(fields: [programDayId], references: [id], onDelete: Cascade)
  name         String      // e.g., "Warm-up", "Main Lifts", "Accessories"
  order        Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  exercises ProgramExercise[]

  @@index([programDayId])
}

model ProgramExercise {
  id               String         @id @default(cuid())
  programSectionId String
  programSection   ProgramSection @relation(fields: [programSectionId], references: [id], onDelete: Cascade)
  exerciseId       String
  exercise         Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  targetSets       Int            @default(3)
  targetRepsMin    Int            @default(8)
  targetRepsMax    Int            @default(12)
  targetRPE        Float?         // Rate of Perceived Exertion (1-10)
  notes            String?        @db.Text
  order            Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  workoutSets WorkoutSet[]

  @@index([programSectionId])
  @@index([exerciseId])
}

// ============================================================================
// WORKOUT LOGGING
// ============================================================================

model WorkoutSession {
  id                 String      @id @default(cuid())
  userId             String
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  programId          String?     // Nullable for free logging
  program            Program?    @relation(fields: [programId], references: [id])
  programDayId       String?     // Nullable for free logging
  programDay         ProgramDay? @relation(fields: [programDayId], references: [id])
  date               DateTime    @default(now())
  perceivedIntensity Int?        // 1-5 scale
  notes              String?     @db.Text
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  // Relations
  sets WorkoutSet[]

  @@index([userId])
  @@index([programId])
  @@index([date])
}

model WorkoutSet {
  id                String           @id @default(cuid())
  workoutSessionId  String
  workoutSession    WorkoutSession   @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  exerciseId        String
  exercise          Exercise         @relation(fields: [exerciseId], references: [id])
  programExerciseId String?          // Link to planned exercise if applicable
  programExercise   ProgramExercise? @relation(fields: [programExerciseId], references: [id])
  setNumber         Int              @default(1)
  weight            Float?           // Nullable for bodyweight
  reps              Int
  equipmentUsed     String?          // e.g., "dumbbell", "barbell", "machine"
  isWarmup          Boolean          @default(false)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([workoutSessionId])
  @@index([exerciseId])
}

// ============================================================================
// BODY WEIGHT TRACKING
// ============================================================================

model BodyWeightEntry {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime @default(now())
  weight    Float    // in kg or lbs (application logic determines unit)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================================================
// CHANGE LOG (Audit Trail)
// ============================================================================

enum ActionType {
  CREATE
  UPDATE
  DELETE
}

enum EntityType {
  PROGRAM
  PROGRAM_WEEK
  PROGRAM_DAY
  PROGRAM_SECTION
  PROGRAM_EXERCISE
  EXERCISE
  WORKOUT_SESSION
  WORKOUT_SET
  BODY_WEIGHT
  USER
  COACH_RELATIONSHIP
}

model ChangeLogEntry {
  id           String     @id @default(cuid())
  actorId      String     // Who made the change
  actor        User       @relation("ActorChangeLogs", fields: [actorId], references: [id])
  targetUserId String     // Whose data was changed
  targetUser   User       @relation("TargetChangeLogs", fields: [targetUserId], references: [id])
  actionType   ActionType
  entityType   EntityType
  entityId     String     // ID of the changed entity
  description  String     // Short summary, e.g., "Created program 'Push/Pull/Legs'"
  metadata     Json?      // Additional context (before/after values, etc.)
  createdAt    DateTime   @default(now())

  @@index([actorId])
  @@index([targetUserId])
  @@index([createdAt])
  @@index([entityType, entityId])
}
